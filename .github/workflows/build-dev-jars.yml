name: Build and Post JAR

#a

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  build_and_post:
    name: Build and Post JAR
    runs-on: ubuntu-latest

    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-d')"

      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set up JDK
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'

      - name: Build with Maven
        run: |
          mvn clean package
          mkdir staging && cp target/fabledrealms-*.jar staging
          git_hash=$(git rev-parse --short "$GITHUB_SHA")
          commit_message=$(git log --format=%B -n 1 $GITHUB_SHA)
          echo "git_hash=$git_hash" >> $GITHUB_ENV
          echo "snapshotVersion=5.5-SNAPSHOT" >> $GITHUB_ENV
          echo "artifactPath=$(pwd)/target" >> $GITHUB_ENV

      - name: Post JAR to Remote Endpoint
        env:
          API_TOKEN: ${{ secrets.API_TOKEN }}
        run: |
          apitoken="${{ env.API_TOKEN }}"
          jar_file=$(find /home/runner/work/FabledRealmsCore/FabledRealmsCore/target/ -name 'fabledrealms-*.jar' -print -quit)
          filename=$(basename $jar_file)
          api_url="https://43pxcj-3000.csb.app/builds/dev/upload?token=$apitoken"
    
          curl -X POST -F "file=@$jar_file" -F "name=jarfile" "$api_url"

